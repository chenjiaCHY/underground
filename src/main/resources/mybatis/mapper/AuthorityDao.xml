<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ntschy.underground.dao.AuthorityDao">

    <select id="getSysUserInfo" resultType="com.ntschy.underground.entity.vo.UserInfoVO">
        SELECT UserId, Account, Name, Sex, Phone, Department, RoleId, Status
        FROM SYS_USER
        <where>
            <if test="userId != null and userId != ''">
                AND UserId = #{userId,jdbcType=VARCHAR}
            </if>
            <if test="account != null and account != ''">
                AND Account = #{account,jdbcType=VARCHAR}
            </if>
            <if test="pwd != null and pwd != ''">
                AND Password = #{pwd,jdbcType=VARCHAR}
            </if>
            <if test="status != null">
                AND Status = #{status,jdbcType=INTEGER}
            </if>
        </where>
    </select>

    <insert id="insertLoginToken" parameterType="com.ntschy.underground.entity.vo.LoginToken">
        INSERT INTO SYS_TOKEN(TokenId, UserId, Token, ExpiresTime, CreateTime, Status)
        VALUES (#{tokenId}, #{userId}, #{token}, #{expiresTime}, #{createTime}, #{status})
    </insert>

    <resultMap id="RoleInfoVO" type="com.ntschy.underground.entity.vo.RoleInfoVO">
        <result column="RoleId" property="roleId"/>
        <result column="Name" property="roleName"/>
        <result column="CreateTime" property="createTime"/>
        <result column="Status" property="status"/>
        <collection property="actionList" ofType="com.ntschy.underground.entity.Action">
            <result column="ActionId" property="actionId"/>
            <result column="ActionName" property="name"/>
            <result column="Sort" property="sort"/>
        </collection>
    </resultMap>

    <select id="getSysRoleInfo" resultMap="RoleInfoVO">
        SELECT
            SR.RoleId,
            SR.Name,
            SR.CreateTime,
            ST.ActionId,
            ST.Name AS ActionName,
            ST.Sort
        FROM
            SYS_ROLE SR
        LEFT JOIN (
            SELECT
                SRAM.RoleId,
                SA.ActionId,
                SA.Name,
                SA.Sort
            FROM
                SYS_ROLE_ACTION_MAPPING SRAM,
                SYS_ACTION SA
            WHERE
                SRAM.ActionId = SA.ActionId AND SRAM.RoleId = #{roleId,jdbcType=VARCHAR}
        ) ST ON SR.RoleId = ST.RoleId
        WHERE SR.RoleId = #{roleId,jdbcType=VARCHAR}
    </select>

    <select id="getRoleCountByName" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM SYS_ROLE
        WHERE RoleId != #{roleId,jdbcType=VARCHAR} AND Name = #{roleName,jdbcType=VARCHAR}
    </select>

    <delete id="deleteRoleActionMapping">
        DELETE FROM SYS_ROLE_ACTION_MAPPING
        WHERE RoleId = #{roleId,jdbcType=VARCHAR}
    </delete>

    <delete id="deleteRole">
        DELETE FROM SYS_ROLE
        WHERE RoleId = #{roleId,jdbcType=VARCHAR}
    </delete>

    <insert id="insertRoleActionMapping" parameterType="list" useGeneratedKeys="false">
        INSERT INTO SYS_ROLE_ACTION_MAPPING(RoleId, ActionId)
        VALUES
        <foreach collection="mappings" item="item" separator=",">
            (#{item.roleId,jdbcType=VARCHAR}, #{item.actionId,jdbcType=VARCHAR})
        </foreach>
    </insert>

    <insert id="insertRole" parameterType="com.ntschy.underground.entity.vo.RoleInfoVO">
        INSERT INTO SYS_ROLE(RoleId, Name, CreateTime)
        VALUES (#{roleId,jdbcType=VARCHAR}, #{roleName,jdbcType=VARCHAR}, #{createTime,jdbcType=VARCHAR})
    </insert>

    <update id="updateRole" parameterType="com.ntschy.underground.entity.vo.RoleInfoVO">
        UPDATE SYS_ROLE
        SET Name = #{roleName,jdbcType=VARCHAR}
        WHERE RoleId = #{roleId,jdbcType=VARCHAR}
    </update>

    <select id="getUserCountByAccount" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM SYS_USER
        WHERE UserId != #{userId,jdbcType=VARCHAR} AND Account = #{account,jdbcType=VARCHAR}
    </select>

    <insert id="insertUser" parameterType="com.ntschy.underground.entity.dto.ModifyUserRequest">
        INSERT INTO SYS_USER(UserId, Account, Name, Password, Sex, Phone, Department, RoleId, Status)
        VALUES (#{userId,jdbcType=VARCHAR}, #{account,jdbcType=VARCHAR}, #{name,jdbcType=VARCHAR}, #{password,jdbcType=VARCHAR},
        #{sex,jdbcType=VARCHAR}, #{phone,jdbcType=VARCHAR}, #{department,jdbcType=VARCHAR}, #{roleId,jdbcType=VARCHAR}, 1)
    </insert>

    <update id="updateUser">
        UPDATE SYS_USER
        SET Department = #{department,jdbcType=VARCHAR}, Phone = #{phone,jdbcType=VARCHAR}, RoleId = #{roleId,jdbcType=VARCHAR}
        WHERE UserId =#{userId,jdbcType=VARCHAR}
    </update>

    <delete id="deleteUser">
        DELETE FROM SYS_USER
        WHERE UserId = #{userId,jdbcType=VARCHAR}
    </delete>

    <select id="getActionList" resultType="com.ntschy.underground.entity.Action">
        SELECT ActionId, Name, Sort
        FROM SYS_ACTION
        ORDER BY Sort
    </select>

    <select id="getFullRoleList" resultType="com.ntschy.underground.entity.vo.RoleInfoVO">
        SELECT RoleId, Name AS RoleName, CreateTime
        FROM SYS_ROLE
        ORDER BY CreateTime
    </select>
</mapper>